#!/usr/bin/env python3
import json, os, shutil, time, subprocess, threading
from pathlib import Path
from http.server import HTTPServer, SimpleHTTPRequestHandler
from urllib.parse import unquote, parse_qs

BASE_DIR = "/storage/emulated/0"
JSON_FILE = "/tmp/retrofs.json"
HTML_FILE = "/data/data/com.termux/files/home/retrofs.html"
INDEX_FILE = "/tmp/retrofs_index.json"
PORT = 8080

# === Index ===
def build_index():
    index = []
    for root, dirs, files in os.walk(BASE_DIR):
        for f in files + dirs:
            path = os.path.join(root, f)
            rel = os.path.relpath(path, BASE_DIR)
            index.append({
                "name": f,
                "path": path,
                "rel": rel,
                "size": format_size(os.path.getsize(path)) if os.path.isfile(path) else "Folder"
            })
    Path(INDEX_FILE).write_text(json.dumps(index))
    return index

def search_index(query):
    index = json.loads(Path(INDEX_FILE).read_text())
    query = query.lower()
    return [f for f in index if query in f["name"].lower() or query in f["rel"].lower()]

# === Helpers ===
def trigger_animation(anim_id):
    html = Path(HTML_FILE).read_text()
    trigger = f'id="{anim_id}" class="trigger"'
    checked = f'id="{anim_id}" class="trigger" checked'
    if checked not in html:
        html = html.replace(trigger, checked)
        Path(HTML_FILE).write_text(html)
        time.sleep(3)
        html = html.replace(checked, trigger)
        Path(HTML_FILE).write_text(html)

def list_dir(path):
    path = Path(path)
    if not path.exists(): return []
    files = []
    for p in path.iterdir():
        try:
            stat = p.stat()
            files.append({
                "name": p.name,
                "path": str(p),
                "size": format_size(stat.st_size) if p.is_file() else "Folder",
                "is_dir": p.is_dir()
            })
        except: pass
    return sorted(files, key=lambda x: (not x["is_dir"], x["name"].lower()))

def format_size(b):
    for u in ['B', 'KB', 'MB', 'GB']: 
        if b < 1024: return f"{b:.1f} {u}"
        b /= 1024
    return f"{b:.1f} TB"

def update_json(path=BASE_DIR):
    data = {"path": str(path), "files": list_dir(path), "time": int(time.time())}
    Path(JSON_FILE).write_text(json.dumps(data))

# === HTTP Handler ===
class Handler(SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path.startswith("/api/search"):
            query = parse_qs(self.path.split("?")[1]).get("q", [""])[0]
            results = search_index(query)
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            self.wfile.write(json.dumps({"files": results}).encode())
        elif self.path.startswith("/api/"):
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            if "ls" in self.path:
                path = unquote(self.path.split("ls/")[1] or BASE_DIR)
                update_json(path)
            self.wfile.write(Path(JSON_FILE).read_bytes())
        else:
            super().do_GET()

    def do_POST(self):
        if self.path == "/upload":
            # ... same upload code ...
            pass
        else:
            super().do_POST()

# === Background Index Rebuild ===
def rebuild_index_loop():
    while True:
        build_index()
        time.sleep(300)  # Every 5 min

def start_server():
    build_index()
    threading.Thread(target=rebuild_index_loop, daemon=True).start()
    update_json()
    server = HTTPServer(("127.0.0.1", PORT), Handler)
    print(f"RetroFS LIVE: http://127.0.0.1:{PORT}/retrofs.html")
    server.serve_forever()

if __name__ == "__main__":
    start_server()