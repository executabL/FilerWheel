#!/usr/bin/env python3
import json, os, shutil, time, subprocess, threading
from pathlib import Path
from http.server import HTTPServer, SimpleHTTPRequestHandler
from urllib.parse import unquote

# === CONFIG ===
BASE_DIR = "/storage/emulated/0"  # Android shared storage
JSON_FILE = "/tmp/retrofs.json"
HTML_FILE = "/data/data/com.termux/files/home/retrofs.html"
PORT = 8080

# === Helpers ===
def trigger_animation(anim_id):
    html = Path(HTML_FILE).read_text()
    trigger = f'id="{anim_id}" class="trigger"'
    checked = f'id="{anim_id}" class="trigger" checked'
    if checked not in html:
        html = html.replace(trigger, checked)
        Path(HTML_FILE).write_text(html)
        time.sleep(3)
        html = html.replace(checked, trigger)
        Path(HTML_FILE).write_text(html)

def list_dir(path):
    path = Path(path)
    if not path.exists():
        return []
    files = []
    for p in path.iterdir():
        try:
            stat = p.stat()
            files.append({
                "name": p.name,
                "path": str(p),
                "size": format_size(stat.st_size) if p.is_file() else "Folder",
                "is_dir": p.is_dir()
            })
        except: pass
    return sorted(files, key=lambda x: (not x["is_dir"], x["name"].lower()))

def format_size(bytes):
    for unit in ['B', 'KB', 'MB', 'GB']:
        if bytes < 1024: return f"{bytes:.1f} {unit}"
        bytes /= 1024
    return f"{bytes:.1f} TB"

def update_json(path=BASE_DIR):
    data = {
        "path": str(path),
        "files": list_dir(path),
        "time": int(time.time())
    }
    Path(JSON_FILE).write_text(json.dumps(data))

# === HTTP Handler ===
class Handler(SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path.startswith("/api/"):
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            if "ls" in self.path:
                path = unquote(self.path.split("ls/")[1] or BASE_DIR)
                update_json(path)
            self.wfile.write(Path(JSON_FILE).read_bytes())
        else:
            super().do_GET()

    def do_POST(self):
        length = int(self.headers.get('Content-Length', 0))
        body = self.rfile.read(length).decode()
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"OK")

        action = self.path.split("/")[1]
        if action == "mkdir":
            name = body.split("=")[1]
            os.makedirs(os.path.join(BASE_DIR, name), exist_ok=True)
            trigger_animation("gears")
        elif action == "delete":
            path = unquote(body.split("=")[1])
            if os.path.exists(path):
                if os.path.isdir(path): shutil.rmtree(path)
                else: os.remove(path)
            trigger_animation("vault")
        elif action == "rename":
            parts = body.split("&")
            old = unquote(parts[0].split("=")[1])
            new = unquote(parts[1].split("=")[1])
            os.rename(old, new)
            trigger_animation("tube")
        update_json()

# === Start Server ===
def start_server():
    update_json()
    server = HTTPServer(("127.0.0.1", PORT), Handler)
    print(f"RetroFS UI: http://127.0.0.1:{PORT}/retrofs.html")
    server.serve_forever()

if __name__ == "__main__":
    threading.Thread(target=start_server, daemon=True).start()
    try:
        while True: time.sleep(1)
    except: pass