#!/usr/bin/env python3
import json, os, shutil, time, subprocess, threading
from pathlib import Path
from http.server import HTTPServer, SimpleHTTPRequestHandler
from urllib.parse import unquote, parse_qs

BASE_DIR = "/storage/emulated/0"
JSON_FILE = "/tmp/retrofs.json"
HTML_FILE = "/data/data/com.termux/files/home/retrofs.html"
PORT = 8080

def trigger_animation(anim_id):
    html = Path(HTML_FILE).read_text()
    trigger = f'id="{anim_id}" class="trigger"'
    checked = f'id="{anim_id}" class="trigger" checked'
    if checked not in html:
        html = html.replace(trigger, checked)
        Path(HTML_FILE).write_text(html)
        time.sleep(3)
        html = html.replace(checked, trigger)
        Path(HTML_FILE).write_text(html)

def list_dir(path):
    path = Path(path)
    if not path.exists(): return []
    files = []
    for p in path.iterdir():
        try:
            stat = p.stat()
            files.append({
                "name": p.name,
                "path": str(p),
                "size": format_size(stat.st_size) if p.is_file() else "Folder",
                "is_dir": p.is_dir()
            })
        except: pass
    return sorted(files, key=lambda x: (not x["is_dir"], x["name"].lower()))

def format_size(b):
    for u in ['B', 'KB', 'MB', 'GB']: 
        if b < 1024: return f"{b:.1f} {u}"
        b /= 1024
    return f"{b:.1f} TB"

def update_json(path=BASE_DIR):
    data = {"path": str(path), "files": list_dir(path), "time": int(time.time())}
    Path(JSON_FILE).write_text(json.dumps(data))

class Handler(SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path.startswith("/api/"):
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            if "ls" in self.path:
                path = unquote(self.path.split("ls/")[1] or BASE_DIR)
                update_json(path)
            self.wfile.write(Path(JSON_FILE).read_bytes())
        else:
            super().do_GET()

    def do_POST(self):
        if self.path == "/upload":
            length = int(self.headers.get('Content-Length', 0))
            boundary = self.headers['Content-Type'].split("boundary=")[1]
            body = self.rfile.read(length)
            parts = body.split(b'--' + boundary.encode())
            for part in parts:
                if b'filename="' in part:
                    filename = part.split(b'filename="')[1].split(b'"')[0].decode()
                    data = part.split(b'\r\n\r\n')[1].rsplit(b'\r\n--', 1)[0]
                    dest = Path(BASE_DIR) / filename
                    dest.write_bytes(data