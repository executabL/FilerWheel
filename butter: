#!/usr/bin/env python3
import os, time, json, requests, redis

SERVICES = json.loads(os.getenv("SERVICES",'[{"name":"intake","url":"http://intake:8080/health"},{"name":"bridge","url":"http://bridge:9091/health"}]'))
REDIS_URL = os.getenv("REDIS_URL","redis://redis:6379/0")
DRAIN_KEY = os.getenv("DRAIN_KEY","filer:drain_mode")
POLL_SEC = int(os.getenv("POLL_SEC","10"))

def healthy(url):
    try:
        r = requests.get(url, timeout=2)
        return r.status_code == 200
    except Exception:
        return False

def main():
    r = redis.from_url(REDIS_URL)
    while True:
        drain = r.get(DRAIN_KEY)
        drain_active = (drain and drain.decode()=="true")
        for svc in SERVICES:
            ok = healthy(svc["url"])
            status = "ok" if ok else "fail"
            print(f"[watcher] {svc['name']} -> {status} (drain={drain_active})")
            if drain_active:
                r.set("filer:worker:pause","true", ex=30)
        time.sleep(POLL_SEC)

if __name__ == "__main__":
    main()
